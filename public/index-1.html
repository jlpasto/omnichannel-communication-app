<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .chat-container {
            width: 100%;
            max-width: 600px;
            background: #fff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: 90vh;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1.5rem; /* p-6 */
            overflow-y: auto;
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
        }
        .chat-input-area {
            padding: 1.5rem; /* p-6 */
            display: flex;
            flex-direction: column;
            gap: 1rem; /* space-y-4 */
        }
        .message-bubble {
            background-color: #e9ecef; /* Slightly lighter gray for incoming messages */
            padding: 0.75rem 1rem; /* px-4 py-3 */
            border-radius: 1rem; /* More rounded corners, like Messenger */
            margin-bottom: 0.5rem; /* mb-2 */
            max-width: 75%; /* Limit width for better readability */
            word-wrap: break-word;
            margin-right: auto; /* Ensure incoming messages align left */
        }
        .message-bubble strong {
            color: #343a40; /* Darker text for username */
            margin-right: 0.5rem;
        }
        .message-bubble.own-message {
            background-color: #3b82f6; /* Blue for outgoing messages (Tailwind blue-500) */
            color: #ffffff; /* White text for own messages */
            margin-left: auto; /* Align own messages to the right */
            margin-right: 0; /* Override default margin-right */
        }
        .message-bubble.own-message strong {
            color: #e0f2fe; /* Lighter text for username in own messages */
        }
        .timestamp {
            font-size: 0.75rem; /* text-xs */
            color: #6c757d; /* Slightly darker gray for timestamp */
            margin-left: 0.5rem;
            display: inline-block;
        }
        .message-bubble.own-message .timestamp {
            color: #bfdbfe; /* Lighter color for timestamp in own messages */
        }
        #login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 2rem;
            background: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 400px;
        }
        #login-error {
            color: #ef4444; /* text-red-500 */
            font-size: 0.875rem; /* text-sm */
        }
        .user-list {
            padding: 0.75rem 1.5rem;
            background-color: #f7fafc; /* bg-gray-100 */
            border-bottom: 1px solid #e5e7eb;
            color: #4a5568;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="login-section" class="flex justify-center items-center h-screen w-full">
        <form id="login-form" class="bg-white p-8 rounded-xl shadow-xl flex flex-col gap-4">
            <h2 class="text-2xl font-bold text-center text-gray-800">Login to Chat</h2>
            <input type="text" id="username" placeholder="Username (user1 or user2)" required
                   class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="password" placeholder="Password (pass1 or pass2)" required
                   class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="bg-blue-600 text-white p-3 rounded-md font-semibold hover:bg-blue-700 transition duration-200">Login</button>
            <p id="login-error" class="text-center text-red-500 text-sm"></p>
        </form>
    </div>

    <div id="chat-section" class="hidden chat-container">
        <div class="user-list">
            <strong class="text-blue-600">Logged in as: <span id="current-username"></span></strong>
            <span class="ml-4 text-gray-600">Active users: <span id="active-users-count">0</span></span>
            <span class="ml-2 text-gray-500" id="active-users-list"></span>
        </div>
        <div class="chat-messages" id="messages">
            <!-- Messages will be appended here -->
        </div>
        <div class="chat-input-area">
            <input type="text" id="message-input" placeholder="Type a message..."
                   class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex gap-2">
                <input type="file" id="attachment-input" class="hidden" accept="image/*, application/pdf, .txt">
                <button id="attach-button" class="bg-yellow-500 text-white p-3 rounded-md font-semibold hover:bg-yellow-600 transition duration-200 w-1/2">Attach File</button>
                <button id="send-button" class="bg-green-600 text-white p-3 rounded-md font-semibold hover:bg-green-700 transition duration-200 w-1/2">Send</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const loginSection = document.getElementById('login-section');
        const chatSection = document.getElementById('chat-section');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const currentUsernameSpan = document.getElementById('current-username');
        const activeUsersCountSpan = document.getElementById('active-users-count');
        const activeUsersListSpan = document.getElementById('active-users-list');

        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const attachButton = document.getElementById('attach-button');
        const attachmentInput = document.getElementById('attachment-input');

        let socket;
        let loggedInUsername = '';

        // --- Utility to format timestamp ---
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // --- Display Message Function ---
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble');

            if (message.user === loggedInUsername) {
                messageElement.classList.add('own-message');
            }

            if (message.text) {
                messageElement.innerHTML = `<strong>${message.user}:</strong> ${message.text} <span class="timestamp">${formatTimestamp(message.timestamp)}</span>`;
            } else if (message.attachment) {
                const link = document.createElement('a');
                link.href = message.attachment.url;
                link.textContent = `Attached: ${message.attachment.filename}`;
                link.target = '_blank'; // Open in new tab
                link.classList.add('text-blue-600', 'hover:underline'); // Tailwind classes for link styling

                messageElement.innerHTML = `<strong>${message.user}:</strong> `;
                messageElement.appendChild(link);
                messageElement.innerHTML += `<span class="timestamp">${formatTimestamp(message.timestamp)}</span>`;
            }

            messagesContainer.appendChild(messageElement);
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- Login Form Submission ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();

                if (data.success) {
                    loggedInUsername = data.username;
                    currentUsernameSpan.textContent = loggedInUsername;
                    loginSection.classList.add('hidden');
                    chatSection.classList.remove('hidden');
                    initializeSocket(loggedInUsername);
                } else {
                    loginError.textContent = data.message;
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'An error occurred during login. Please try again.';
            }
        });

        // --- Initialize Socket.IO Connection ---
        function initializeSocket(username) {
            socket = io();

            socket.on('connect', () => {
                console.log('Connected to Socket.IO server.');
                // Send username for socket-level authentication
                socket.emit('authenticate', username);
            });

            socket.on('authenticated', (success, message) => {
                if (success) {
                    console.log('Socket authenticated successfully.');
                } else {
                    console.error('Socket authentication failed:', message);
                    // Handle re-login or error display
                    alert('Socket authentication failed: ' + message + '. Please refresh.');
                    window.location.reload();
                }
            });

            socket.on('chat_message', (msg) => {
                displayMessage(msg);
            });

            socket.on('user_status_update', (activeUsers) => {
                activeUsersCountSpan.textContent = activeUsers.length;
                activeUsersListSpan.textContent = `(${activeUsers.join(', ')})`;
            });

            socket.on('error_message', (msg) => {
                alert('Server error: ' + msg); // Use alert for simplicity as per "minimal"
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from Socket.IO server.');
            });
        }

        // --- Send Message Button Click ---
        sendButton.addEventListener('click', () => {
            const messageText = messageInput.value.trim();
            if (messageText) {
                socket.emit('chat_message', messageText);
                messageInput.value = '';
            }
        });

        // --- Send Message on Enter Key ---
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        // --- Attach Button Click (triggers hidden file input) ---
        attachButton.addEventListener('click', () => {
            attachmentInput.click();
        });

        // --- Attachment Input Change (when a file is selected) ---
        attachmentInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('attachment', file);
                formData.append('username', loggedInUsername); // Include username for server-side auth check

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData,
                    });

                    const data = await response.json();
                    if (data.success) {
                        console.log('File upload successful:', data.fileUrl);
                        // The server will broadcast the message, so no need to display here immediately
                    } else {
                        alert('File upload failed: ' + data.message);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('An error occurred during file upload.');
                } finally {
                    attachmentInput.value = ''; // Clear the input so same file can be selected again
                }
            }
        });

    </script>
</body>
</html>
